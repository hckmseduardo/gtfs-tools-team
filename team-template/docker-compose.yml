# GTFS-Editor Team Instance Template
# This template is used by the orchestrator to provision new teams
# Environment variables are substituted at deployment time:
#   - TEAM_SLUG: Team identifier (e.g., "acme-transit")
#   - DOMAIN: Base domain (e.g., "app.gtfs-tools.com")
#   - DATA_PATH: Host path for team data
#   - TEAM_DB_PASSWORD: PostgreSQL password
#   - TEAM_SECRET_KEY: Application secret key
#   - CROSS_DOMAIN_SECRET: Cross-domain auth secret
#
# Sandbox mode (when SANDBOX_MODE=true):
#   - SANDBOX_CODE_PATH: Path to cloned sandbox code
#   - SANDBOX_BRANCH: Git branch name for the sandbox
#   - Services build from local code instead of shared images
#   - Kanban-agent targets the local code folder

services:
  # Team's PostgreSQL with PostGIS
  postgres:
    image: postgis/postgis:16-3.4
    container_name: gtfs-team-${TEAM_SLUG}-postgres
    environment:
      POSTGRES_DB: gtfs_editor
      POSTGRES_USER: gtfs_user
      POSTGRES_PASSWORD: ${TEAM_DB_PASSWORD}
    volumes:
      - ${DATA_PATH}/postgres:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
    networks:
      - team-internal
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gtfs_user -d gtfs_editor"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Team's Redis (for Celery)
  redis:
    image: redis:7-alpine
    container_name: gtfs-team-${TEAM_SLUG}-redis
    command: redis-server --appendonly yes
    volumes:
      - ${DATA_PATH}/redis:/data
    networks:
      - team-internal
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Team's Backend API
  # In sandbox mode (SANDBOX_MODE=true), uses sandbox-specific image built from local code
  # In normal mode, uses shared gtfs-team-api:latest image
  api:
    image: ${SANDBOX_API_IMAGE:-gtfs-team-api:latest}
    container_name: gtfs-team-${TEAM_SLUG}-api
    environment:
      - TEAM_SLUG=${TEAM_SLUG}
      - DOMAIN=${DOMAIN}
      - DATABASE_URL=postgresql+asyncpg://gtfs_user:${TEAM_DB_PASSWORD}@gtfs-team-${TEAM_SLUG}-postgres:5432/gtfs_editor
      - REDIS_URL=redis://gtfs-team-${TEAM_SLUG}-redis:6379/0
      - CELERY_BROKER_URL=redis://gtfs-team-${TEAM_SLUG}-redis:6379/1
      - CELERY_RESULT_BACKEND=redis://gtfs-team-${TEAM_SLUG}-redis:6379/2
      - VALHALLA_URL=http://gtfs-valhalla:8002
      - SECRET_KEY=${TEAM_SECRET_KEY}
      - CROSS_DOMAIN_SECRET=${CROSS_DOMAIN_SECRET}
      - PORTAL_API_URL=https://${DOMAIN}/api
      - GTFS_VALIDATION_HOST_PATH=${GTFS_VALIDATION_HOST_PATH:-/Volumes/dados/projects/GTFS-Editor/validation_data}
      # Email configuration (SMTP)
      - EMAIL_PROVIDER=${EMAIL_PROVIDER:-smtp}
      - EMAIL_FROM_EMAIL=${EMAIL_FROM_EMAIL}
      - EMAIL_FROM_NAME=${EMAIL_FROM_NAME:-GTFS Editor}
      - SMTP_HOST=${SMTP_HOST:-smtp.protonmail.ch}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
    volumes:
      - ${DATA_PATH}/uploads:/tmp/gtfs-uploads
      # Share validation output/input directory with host so API can serve reports
      - ${GTFS_VALIDATION_HOST_PATH:-/Volumes/dados/projects/GTFS-Editor/validation_data}:/tmp/gtfs-validation-output
    networks:
      - team-internal
      - gtfs-network
    labels:
      - "traefik.enable=true"
      # API routing (no strip prefix - backend expects /api/v1/...)
      # Prefixed with 'gtfs-' to avoid conflicts with other projects (e.g., kanban)
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-api.rule=Host(`${TEAM_SLUG}.${DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-api.entrypoints=websecure"
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-api.tls=true"
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-api.service=gtfs-${TEAM_SLUG}-api"
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-api.middlewares=cors-headers@file,secure-headers@file"
      - "traefik.http.services.gtfs-${TEAM_SLUG}-api.loadbalancer.server.port=8000"
      # WebSocket routing
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-ws.rule=Host(`${TEAM_SLUG}.${DOMAIN}`) && PathPrefix(`/ws`)"
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-ws.entrypoints=websecure"
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-ws.tls=true"
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-ws.tls.certresolver=letsencrypt"
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-ws.service=gtfs-${TEAM_SLUG}-ws"
      - "traefik.http.services.gtfs-${TEAM_SLUG}-ws.loadbalancer.server.port=8000"
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # Team's Celery Worker
  # Uses same image as API (sandbox-specific or shared)
  worker:
    image: ${SANDBOX_API_IMAGE:-gtfs-team-api:latest}
    container_name: gtfs-team-${TEAM_SLUG}-worker
    command: celery -A app.tasks worker --loglevel=info --concurrency=2
    environment:
      - TEAM_SLUG=${TEAM_SLUG}
      - DATABASE_URL=postgresql+asyncpg://gtfs_user:${TEAM_DB_PASSWORD}@gtfs-team-${TEAM_SLUG}-postgres:5432/gtfs_editor
      - REDIS_URL=redis://gtfs-team-${TEAM_SLUG}-redis:6379/0
      - CELERY_BROKER_URL=redis://gtfs-team-${TEAM_SLUG}-redis:6379/1
      - CELERY_RESULT_BACKEND=redis://gtfs-team-${TEAM_SLUG}-redis:6379/2
      - VALHALLA_URL=http://gtfs-valhalla:8002
      - GTFS_VALIDATION_HOST_PATH=${GTFS_VALIDATION_HOST_PATH:-/Volumes/dados/projects/GTFS-Editor/validation_data}
    volumes:
      - ${DATA_PATH}/uploads:/tmp/gtfs-uploads
      # Allow running dockerized GTFS validators (MobilityData)
      - /var/run/docker.sock:/var/run/docker.sock
      # Share validation output/input directory with host for validator container
      - ${GTFS_VALIDATION_HOST_PATH:-/Volumes/dados/projects/GTFS-Editor/validation_data}:/tmp/gtfs-validation-output
    networks:
      - team-internal
      - gtfs-network
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # Team's Celery Beat (scheduler)
  # Uses same image as API (sandbox-specific or shared)
  beat:
    image: ${SANDBOX_API_IMAGE:-gtfs-team-api:latest}
    container_name: gtfs-team-${TEAM_SLUG}-beat
    command: celery -A app.tasks beat --loglevel=info
    environment:
      - TEAM_SLUG=${TEAM_SLUG}
      - DATABASE_URL=postgresql+asyncpg://gtfs_user:${TEAM_DB_PASSWORD}@gtfs-team-${TEAM_SLUG}-postgres:5432/gtfs_editor
      - CELERY_BROKER_URL=redis://gtfs-team-${TEAM_SLUG}-redis:6379/1
      - CELERY_RESULT_BACKEND=redis://gtfs-team-${TEAM_SLUG}-redis:6379/2
    networks:
      - team-internal
    restart: unless-stopped
    depends_on:
      - worker

  # Team's Frontend
  # In sandbox mode (SANDBOX_MODE=true), uses sandbox-specific image built from local code
  # In normal mode, uses shared gtfs-team-web:latest image
  web:
    image: ${SANDBOX_WEB_IMAGE:-gtfs-team-web:latest}
    container_name: gtfs-team-${TEAM_SLUG}-web
    environment:
      - VITE_API_URL=https://${TEAM_SLUG}.${DOMAIN}/api/v1
      - VITE_TEAM_SLUG=${TEAM_SLUG}
    networks:
      - gtfs-network
    labels:
      - "traefik.enable=true"
      # Prefixed with 'gtfs-' to avoid conflicts with other projects (e.g., kanban)
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-web.rule=Host(`${TEAM_SLUG}.${DOMAIN}`) && !PathPrefix(`/api`) && !PathPrefix(`/ws`) && !PathPrefix(`/kanban`)"
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-web.entrypoints=websecure"
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-web.tls=true"
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-web.tls.certresolver=letsencrypt"
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-web.service=gtfs-${TEAM_SLUG}-web"
      - "traefik.http.routers.gtfs-${TEAM_SLUG}-web.middlewares=secure-headers@file,compress@file"
      - "traefik.http.services.gtfs-${TEAM_SLUG}-web.loadbalancer.server.port=80"
    restart: unless-stopped

  # Team's Kanban AI Agents (connects to external kanban.amazing-ai.tools)
  # In sandbox mode, targets the local cloned code folder
  kanban-agent:
    build:
      context: ./kanban-agent
      dockerfile: Dockerfile
    image: gtfs-team-kanban-agent:latest
    container_name: gtfs-team-${TEAM_SLUG}-kanban-agent
    environment:
      # Git repository settings (pulls latest code on startup)
      - KANBAN_AGENTS_REPO=${KANBAN_AGENTS_REPO:-https://github.com/hckmseduardo/kanban-agents.git}
      - KANBAN_AGENTS_BRANCH=${KANBAN_AGENTS_BRANCH:-main}
      - AUTO_UPDATE=${AUTO_UPDATE:-true}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      # Team context
      - TEAM_SLUG=${TEAM_SLUG}
      # Sandbox mode settings
      - SANDBOX_MODE=${SANDBOX_MODE:-false}
      - SANDBOX_BRANCH=${SANDBOX_BRANCH:-}
      # Kanban API settings (external kanban service)
      - KANBAN_API_URL=${KANBAN_API_URL:-https://gtfs-tools.kanban.amazing-ai.tools/api}
      - KANBAN_API_TOKEN=${KANBAN_API_TOKEN:-}
      - KANBAN_WEBHOOK_SECRET=${KANBAN_WEBHOOK_SECRET:-}
      # LLM settings
      - LLM_PROVIDER=${LLM_PROVIDER:-anthropic}
      - LLM_MODEL=${LLM_MODEL:-claude-sonnet-4-5-20250929}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS:-32768}
      # Provider-specific API keys
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ABACUS_API_KEY=${ABACUS_API_KEY:-}
      - ABACUS_BASE_URL=${ABACUS_BASE_URL:-}
      # Target project path inside container
      # In sandbox mode, this is the local cloned code folder
      - TARGET_PROJECT_PATH=/app/target-project
      # Server settings
      - HOST=0.0.0.0
      - PORT=8001
      - DEBUG=${DEBUG:-false}
      # SSH settings for host command execution
      - SSH_ENABLED=${SSH_ENABLED:-true}
      - SSH_HOST=${SSH_HOST:-host.docker.internal}
      - SSH_PORT=${SSH_PORT:-22}
      - SSH_USER=${SSH_USER}
      - SSH_KEY_PATH=/root/.ssh/id_ed25519
      # SSH host project path - uses sandbox code path in sandbox mode
      - SSH_HOST_PROJECT_PATH=${SANDBOX_CODE_PATH:-${DATA_PATH}}
      # Command forwarding - POST to webhook instead of executing (for n8n integration)
      - COMMAND_WEBHOOK_URL=${COMMAND_WEBHOOK_URL:-}
    volumes:
      # Mount the target project the agents will work on
      # In sandbox mode, this is the local cloned code folder
      - ${SANDBOX_CODE_PATH:-${DATA_PATH}}:/app/target-project:rw
      # Mount Claude CLI credentials (for Pro subscription)
      - ${HOME}/.claude:/root/.claude:ro
      # Mount SSH key for host command execution
      - ${SSH_KEY_PATH:-${HOME}/.ssh/id_ed25519}:/root/.ssh/id_ed25519:ro
    networks:
      - team-internal
      - gtfs-network
    labels:
      - "traefik.enable=true"
      # Kanban agent webhook routing (only /kanban/webhook path)
      - "traefik.http.routers.kanban-agent-${TEAM_SLUG}.rule=Host(`${TEAM_SLUG}.${DOMAIN}`) && PathPrefix(`/kanban/webhook`)"
      - "traefik.http.routers.kanban-agent-${TEAM_SLUG}.entrypoints=websecure"
      - "traefik.http.routers.kanban-agent-${TEAM_SLUG}.tls=true"
      - "traefik.http.routers.kanban-agent-${TEAM_SLUG}.tls.certresolver=letsencrypt"
      - "traefik.http.routers.kanban-agent-${TEAM_SLUG}.service=kanban-agent-${TEAM_SLUG}"
      - "traefik.http.routers.kanban-agent-${TEAM_SLUG}.middlewares=kanban-agent-${TEAM_SLUG}-strip,cors-headers@file"
      # Strip /kanban prefix before forwarding to the agent
      - "traefik.http.middlewares.kanban-agent-${TEAM_SLUG}-strip.stripprefix.prefixes=/kanban"
      - "traefik.http.services.kanban-agent-${TEAM_SLUG}.loadbalancer.server.port=8001"
    restart: unless-stopped

networks:
  # Team's isolated internal network
  team-internal:
    name: gtfs-team-${TEAM_SLUG}
    driver: bridge
  # Shared network for Traefik and Valhalla access
  gtfs-network:
    external: true
